<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Panel de Administraci√≥n - ¬øQui√©n Quiere Ser Millonario?</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Arial", sans-serif;
        background: linear-gradient(
          135deg,
          #0f0f0f 0%,
          #1a1a2e 50%,
          #16213e 100%
        );
        color: white;
        min-height: 100vh;
        padding: 20px;
      }

      .admin-container {
        max-width: 1200px;
        margin: 0 auto;
      }

      .admin-header {
        text-align: center;
        margin-bottom: 40px;
      }

      .admin-title {
        font-size: 2.5rem;
        margin-bottom: 10px;
        background: linear-gradient(45deg, #ffd700, #ffed4e);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
      }

      .admin-subtitle {
        color: #ccc;
        font-size: 1.2rem;
      }

      .stats-overview {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 40px;
      }

      .stat-card {
        background: rgba(0, 0, 0, 0.7);
        border: 2px solid #ffd700;
        border-radius: 15px;
        padding: 20px;
        text-align: center;
      }

      .stat-number {
        font-size: 2rem;
        color: #ffd700;
        font-weight: bold;
        margin-bottom: 5px;
      }

      .stat-label {
        color: #ccc;
        font-size: 0.9rem;
      }

      .players-table {
        background: rgba(0, 0, 0, 0.7);
        border: 2px solid #ffd700;
        border-radius: 15px;
        overflow: hidden;
        margin-bottom: 20px;
      }

      .table-header {
        background: linear-gradient(45deg, #ffd700, #ffed4e);
        color: #000;
        padding: 15px;
        font-weight: bold;
        font-size: 1.1rem;
      }

      .table-content {
        max-height: 600px;
        overflow-y: auto;
      }

      .player-row {
        display: grid;
        grid-template-columns: 1fr 2fr 1fr 2fr 2fr 1fr;
        gap: 15px;
        padding: 20px;
        border-bottom: 1px solid rgba(255, 215, 0, 0.3);
        align-items: center;
        transition: background 0.3s ease;
      }

      .player-row:hover {
        background: rgba(255, 215, 0, 0.1);
      }

      .player-row:last-child {
        border-bottom: none;
      }

      .player-info {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .player-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: white;
        font-size: 1.2rem;
      }

      .player-name {
        font-weight: bold;
        color: #ffd700;
        font-size: 1.1rem;
      }

      .question-info {
        text-align: center;
      }

      .question-number {
        color: #ffd700;
        font-weight: bold;
        margin-bottom: 5px;
      }

      .prize-amount {
        color: #4caf50;
        font-size: 0.9rem;
      }

      .answer-info {
        text-align: center;
      }

      .last-answer {
        font-weight: bold;
        margin-bottom: 5px;
      }

      .answer-correct {
        color: #4caf50;
      }

      .answer-incorrect {
        color: #f44336;
      }

      .answer-pending {
        color: #ff9800;
      }

      .lifelines-used {
        display: flex;
        gap: 10px;
        justify-content: center;
        flex-wrap: wrap;
      }

      .lifeline-badge {
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: bold;
        text-align: center;
      }

      .lifeline-used {
        background: #666;
        color: #ccc;
      }

      .lifeline-available {
        background: linear-gradient(45deg, #ffd700, #ffed4e);
        color: #000;
      }

      .status-indicator {
        text-align: center;
        font-weight: bold;
        padding: 8px 15px;
        border-radius: 20px;
      }

      .status-playing {
        background: #4caf50;
        color: white;
      }

      .status-eliminated {
        background: #f44336;
        color: white;
      }

      .status-winner {
        background: linear-gradient(45deg, #ffd700, #ffed4e);
        color: #000;
      }

      .refresh-btn {
        background: linear-gradient(45deg, #ffd700, #ffed4e);
        color: #000;
        border: none;
        border-radius: 25px;
        padding: 12px 30px;
        font-size: 1rem;
        font-weight: bold;
        cursor: pointer;
        margin-bottom: 20px;
        transition: transform 0.3s ease;
      }

      .refresh-btn:hover {
        transform: scale(1.05);
      }

      .game-controls {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        justify-content: center;
        flex-wrap: wrap;
      }

      .control-btn {
        background: linear-gradient(45deg, #ffd700, #ffed4e);
        color: #000;
        border: none;
        border-radius: 25px;
        padding: 12px 30px;
        font-size: 1rem;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        min-width: 150px;
      }

      .control-btn:hover {
        transform: scale(1.05);
      }

      .control-btn.start-game {
        background: linear-gradient(45deg, #4caf50, #45a049);
        color: white;
      }

      .control-btn.end-game {
        background: linear-gradient(45deg, #f44336, #d32f2f);
        color: white;
      }

      .control-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      .control-btn:disabled:hover {
        transform: none;
      }

      .game-status {
        text-align: center;
        margin-bottom: 20px;
        padding: 15px;
        border-radius: 10px;
        font-weight: bold;
        font-size: 1.1rem;
      }

      .game-status.active {
        background: rgba(76, 175, 80, 0.2);
        border: 2px solid #4caf50;
        color: #4caf50;
      }

      .game-status.inactive {
        background: rgba(244, 67, 54, 0.2);
        border: 2px solid #f44336;
        color: #f44336;
      }

      .no-players {
        text-align: center;
        padding: 40px;
        color: #ccc;
        font-size: 1.2rem;
      }

      @media (max-width: 768px) {
        .admin-title {
          font-size: 2rem;
        }

        .player-row {
          grid-template-columns: 1fr;
          gap: 10px;
          text-align: center;
        }

        .stats-overview {
          grid-template-columns: repeat(2, 1fr);
        }
      }
    </style>
  </head>
  <body>
    <div class="admin-container">
      <div class="admin-header">
        <h1 class="admin-title">Panel de Administraci√≥n</h1>
        <p class="admin-subtitle">Monitoreo de participantes en tiempo real</p>
      </div>

      <div class="stats-overview">
        <div class="stat-card">
          <div class="stat-number" id="totalPlayers">0</div>
          <div class="stat-label">Total Participantes</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="activePlayers">0</div>
          <div class="stat-label">Jugando Actualmente</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="eliminatedPlayers">0</div>
          <div class="stat-label">Eliminados</div>
        </div>
      </div>

      <div class="game-status" id="gameStatus">
        üî¥ Partida Detenida - Los jugadores no pueden ingresar
      </div>

      <div class="game-controls">
        <button
          class="control-btn start-game"
          id="startGameBtn"
          onclick="startGame()"
        >
          üéÆ Iniciar Partida
        </button>
        <button
          class="control-btn end-game"
          id="endGameBtn"
          onclick="endGame()"
          disabled
        >
          üõë Terminar Partida
        </button>
        <button class="refresh-btn" onclick="refreshData()">
          üîÑ Actualizar Datos
        </button>
      </div>

      <div class="players-table">
        <div class="table-header">Participantes Registrados</div>
        <div class="table-content" id="playersTableContent">
          <!-- Los datos se cargar√°n aqu√≠ -->
        </div>
      </div>
    </div>

    <script>
      // Estado del juego
      let gameState = {
        isActive: false,
        startTime: null,
        endTime: null,
      };

      // WebSocket para comunicaci√≥n en tiempo real
      let ws = null;

      function connectWebSocket() {
        const protocol = window.location.protocol === "https:" ? "wss:" : "ws:";
        const wsUrl = `${protocol}//${window.location.host}/ws`;

        ws = new WebSocket(wsUrl);

        ws.onopen = function () {
          console.log("‚úÖ WebSocket conectado al servidor");
        };

        ws.onmessage = function (event) {
          try {
            const message = JSON.parse(event.data);
            handleWebSocketMessage(message);
          } catch (error) {
            console.error("‚ùå Error procesando mensaje WebSocket:", error);
          }
        };

        ws.onclose = function () {
          console.log(
            "üîå WebSocket desconectado. Reintentando en 3 segundos..."
          );
          setTimeout(connectWebSocket, 3000);
        };

        ws.onerror = function (error) {
          console.error("‚ùå Error WebSocket:", error);
        };
      }

      function handleWebSocketMessage(message) {
        switch (message.type) {
          case "gameState":
            updateGameStateFromWebSocket(message.data);
            break;
          default:
            console.log("üì® Mensaje WebSocket no reconocido:", message);
        }
      }

      function updateGameStateFromWebSocket(newGameState) {
        gameState.isActive = newGameState.isActive;
        gameState.startTime = newGameState.startTime
          ? new Date(newGameState.startTime)
          : null;
        gameState.endTime = newGameState.endTime
          ? new Date(newGameState.endTime)
          : null;

        updateGameStatus();
        updateControlButtons();

        // Mostrar notificaci√≥n
        const status = newGameState.isActive ? "iniciada" : "terminada";
        console.log(`üéÆ Partida ${status} remotamente`);

        // Refrescar datos de jugadores cuando cambie el estado
        setTimeout(refreshData, 1000);
      }

      // Datos de participantes (se cargar√°n desde la API)
      let playersData = [];

      async function loadSessionsData() {
        try {
          const response = await fetch("/api/sessions/active");
          const data = await response.json();

          if (data.success && data.data.sessions) {
            playersData = data.data.sessions.map((session, index) => {
              const avatars = [
                "üéØ",
                "‚≠ê",
                "üî•",
                "üíé",
                "üåü",
                "üé™",
                "üöÄ",
                "üë§",
                "üé®",
                "üéµ",
              ];
              return {
                id: session.id,
                name: session.playerName,
                avatar: avatars[index % avatars.length],
                currentQuestion: session.currentQuestion,
                prizeAmount: `$${session.totalPrize.toLocaleString()}`,
                lastAnswer:
                  session.answersGiven.length > 0
                    ? session.answersGiven[session.answersGiven.length - 1]
                        .selectedOption
                    : "-",
                answerStatus:
                  session.answersGiven.length > 0
                    ? session.answersGiven[session.answersGiven.length - 1]
                        .isCorrect
                      ? "correct"
                      : "incorrect"
                    : "pending",
                lifelinesUsed: {
                  fiftyFifty: session.lifelinesUsed.fiftyFifty,
                  audience: session.lifelinesUsed.audience,
                },
                status:
                  session.gameStatus === "active"
                    ? "playing"
                    : session.gameStatus === "finished"
                    ? session.totalPrize > 0
                      ? "winner"
                      : "eliminated"
                    : "eliminated",
                joinTime: new Date(session.startTime).toLocaleTimeString(),
                sessionObject: session,
              };
            });

            console.log(`‚úÖ ${playersData.length} sesiones activas cargadas`);
          } else {
            playersData = [];
            console.log("‚ÑπÔ∏è No hay sesiones activas");
          }
        } catch (error) {
          console.error("‚ùå Error cargando sesiones:", error);
          playersData = [];
        }
      }

      function updateStats() {
        const total = playersData.length;
        const active = playersData.filter((p) => p.status === "playing").length;
        const eliminated = playersData.filter(
          (p) => p.status === "eliminated"
        ).length;

        document.getElementById("totalPlayers").textContent = total;
        document.getElementById("activePlayers").textContent = active;
        document.getElementById("eliminatedPlayers").textContent = eliminated;
      }

      function getAnswerStatusText(status) {
        switch (status) {
          case "correct":
            return "Correcta";
          case "incorrect":
            return "Incorrecta";
          case "pending":
            return "Pendiente";
          default:
            return "-";
        }
      }

      function getStatusClass(status) {
        switch (status) {
          case "correct":
            return "answer-correct";
          case "incorrect":
            return "answer-incorrect";
          case "pending":
            return "answer-pending";
          default:
            return "";
        }
      }

      function renderLifelines(lifelines) {
        const lifelineNames = {
          fiftyFifty: "50:50",
          audience: "P√∫blico",
        };

        return Object.entries(lifelines)
          .map(([key, used]) => {
            const className = used ? "lifeline-used" : "lifeline-available";
            const text = used
              ? `${lifelineNames[key]} ‚úó`
              : `${lifelineNames[key]} ‚úì`;
            return `<span class="lifeline-badge ${className}">${text}</span>`;
          })
          .join("");
      }

      function getStatusIndicator(status) {
        const statusTexts = {
          playing: "Jugando",
          eliminated: "Eliminado",
          winner: "Ganador",
        };
        return `<div class="status-indicator status-${status}">${statusTexts[status]}</div>`;
      }

      function renderPlayersTable() {
        const tableContent = document.getElementById("playersTableContent");

        if (playersData.length === 0) {
          tableContent.innerHTML =
            '<div class="no-players">No hay participantes registrados</div>';
          return;
        }

        const playersHTML = playersData
          .map(
            (player) => `
                <div class="player-row">
                    <div class="player-info">
                        <div class="player-avatar">${player.avatar}</div>
                        <div>
                            <div class="player-name">${player.name}</div>
                            <div style="color: #999; font-size: 0.8rem;">Ingres√≥: ${
                              player.joinTime
                            }</div>
                        </div>
                    </div>
                    <div class="question-info">
                        <div class="question-number">Pregunta ${
                          player.currentQuestion
                        }/15</div>
                        <div class="prize-amount">${player.prizeAmount}</div>
                    </div>
                    <div class="answer-info">
                        <div class="last-answer ${getStatusClass(
                          player.answerStatus
                        )}">
                            ${player.lastAnswer}
                        </div>
                        <div style="font-size: 0.8rem; color: #ccc;">
                            ${getAnswerStatusText(player.answerStatus)}
                        </div>
                    </div>
                    <div class="lifelines-used">
                        ${renderLifelines(player.lifelinesUsed)}
                    </div>
                    <div>
                        ${getStatusIndicator(player.status)}
                    </div>
                    <div style="text-align: center; color: #ccc; font-size: 0.9rem;">
                        ID: ${player.id.substring(0, 8)}...
                    </div>
                </div>
            `
          )
          .join("");

        tableContent.innerHTML = playersHTML;
      }

      async function refreshData() {
        // Cargar datos reales desde la API
        const refreshBtn = document.querySelector(".refresh-btn");
        refreshBtn.textContent = "üîÑ Actualizando...";
        refreshBtn.disabled = true;

        try {
          await loadSessionsData();
          updateStats();
          renderPlayersTable();

          console.log("‚úÖ Datos actualizados desde la API");
        } catch (error) {
          console.error("‚ùå Error actualizando datos:", error);
        } finally {
          refreshBtn.textContent = "üîÑ Actualizar Datos";
          refreshBtn.disabled = false;
        }
      }

      function getPrizeAmount(questionNumber) {
        const prizes = [
          "$100",
          "$200",
          "$300",
          "$500",
          "$1,000",
          "$2,000",
          "$4,000",
          "$8,000",
          "$16,000",
          "$32,000",
          "$64,000",
          "$125,000",
          "$250,000",
          "$500,000",
          "$1,000,000",
        ];
        return prizes[questionNumber - 1] || "$0";
      }

      // Inicializar la p√°gina
      document.addEventListener("DOMContentLoaded", async function () {
        // Conectar WebSocket
        connectWebSocket();

        // Cargar estado inicial del juego
        await loadGameState();

        updateGameStatus();
        updateControlButtons();

        // Cargar datos iniciales
        await loadSessionsData();
        updateStats();
        renderPlayersTable();

        // Auto-actualizar cada 30 segundos
        setInterval(() => {
          if (!document.querySelector(".refresh-btn").disabled) {
            refreshData();
          }
        }, 30000);
      });

      async function loadGameState() {
        try {
          const response = await fetch("/api/game/state");
          const data = await response.json();

          if (data.success && data.data.gameState) {
            const gs = data.data.gameState;
            gameState.isActive = gs.isActive;
            gameState.startTime = gs.startTime ? new Date(gs.startTime) : null;
            gameState.endTime = gs.endTime ? new Date(gs.endTime) : null;
            console.log("‚úÖ Estado del juego cargado:", gs.message);
          }
        } catch (error) {
          console.error("‚ùå Error cargando estado del juego:", error);
        }
      }

      // Agregar nuevo participante (funci√≥n de ejemplo)
      function addNewPlayer(name) {
        const avatars = [
          "üéØ",
          "‚≠ê",
          "üî•",
          "üíé",
          "üåü",
          "üé™",
          "üöÄ",
          "üë§",
          "üé®",
          "üéµ",
        ];
        const newPlayer = {
          id: playersData.length + 1,
          name: name,
          avatar: avatars[Math.floor(Math.random() * avatars.length)],
          currentQuestion: 1,
          prizeAmount: "$100",
          lastAnswer: "-",
          answerStatus: "pending",
          lifelinesUsed: {
            fiftyFifty: false,
            audience: false,
          },
          status: "playing",
          joinTime: new Date().toLocaleTimeString(),
        };

        playersData.push(newPlayer);
        updateStats();
        renderPlayersTable();
      }

      async function startGame() {
        try {
          const response = await fetch("/api/game/start", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
          });

          const data = await response.json();

          if (data.success) {
            console.log("‚úÖ Partida iniciada:", data.message);
            // El WebSocket se encargar√° de actualizar la UI
          } else {
            alert("‚ùå Error iniciando partida: " + data.error);
          }
        } catch (error) {
          console.error("‚ùå Error iniciando partida:", error);
          alert("Error de conexi√≥n al iniciar partida");
        }
      }

      async function endGame() {
        const confirmEnd = confirm(
          "¬øEst√°s seguro de que quieres terminar la partida? Esto eliminar√° a todos los jugadores activos."
        );

        if (!confirmEnd) return;

        try {
          const response = await fetch("/api/game/end", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
          });

          const data = await response.json();

          if (data.success) {
            console.log("‚úÖ Partida terminada:", data.message);
            // El WebSocket se encargar√° de actualizar la UI
          } else {
            alert("‚ùå Error terminando partida: " + data.error);
          }
        } catch (error) {
          console.error("‚ùå Error terminando partida:", error);
          alert("Error de conexi√≥n al terminar partida");
        }
      }

      function updateGameStatus() {
        const statusElement = document.getElementById("gameStatus");

        if (gameState.isActive) {
          statusElement.className = "game-status active";
          statusElement.innerHTML = `
                    üü¢ Partida Activa - Los jugadores pueden ingresar
                    <br><small>Iniciada: ${gameState.startTime.toLocaleTimeString()}</small>
                `;
        } else {
          statusElement.className = "game-status inactive";
          const endTimeText = gameState.endTime
            ? `<br><small>Terminada: ${gameState.endTime.toLocaleTimeString()}</small>`
            : "";
          statusElement.innerHTML = `
                    üî¥ Partida Detenida - Los jugadores no pueden ingresar
                    ${endTimeText}
                `;
        }
      }

      function updateControlButtons() {
        const startBtn = document.getElementById("startGameBtn");
        const endBtn = document.getElementById("endGameBtn");

        if (gameState.isActive) {
          startBtn.disabled = true;
          startBtn.textContent = "üéÆ Partida en Curso";
          endBtn.disabled = false;
          endBtn.textContent = "üõë Terminar Partida";
        } else {
          startBtn.disabled = false;
          startBtn.textContent = "üéÆ Iniciar Partida";
          endBtn.disabled = true;
          endBtn.textContent = "üõë Partida Detenida";
        }
      }
    </script>
  </body>
</html>
