<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Panel de Administración - ¿Quién Quiere Ser Millonario?</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Arial", sans-serif;
        background: linear-gradient(
          135deg,
          #0f0f0f 0%,
          #1a1a2e 50%,
          #16213e 100%
        );
        color: white;
        min-height: 100vh;
        padding: 20px;
      }

      .admin-container {
        max-width: 1200px;
        margin: 0 auto;
      }

      .admin-header {
        text-align: center;
        margin-bottom: 40px;
      }

      .admin-title {
        font-size: 2.5rem;
        margin-bottom: 10px;
        background: linear-gradient(45deg, #ffd700, #ffed4e);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
      }

      .admin-subtitle {
        color: #ccc;
        font-size: 1.2rem;
      }

      .stats-overview {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 15px;
        margin-bottom: 40px;
      }

      .stat-card {
        background: rgba(0, 0, 0, 0.7);
        border: 2px solid #ffd700;
        border-radius: 15px;
        padding: 20px;
        text-align: center;
      }

      .stat-number {
        font-size: 2rem;
        color: #ffd700;
        font-weight: bold;
        margin-bottom: 5px;
      }

      .stat-label {
        color: #ccc;
        font-size: 0.9rem;
      }

      .players-table {
        background: rgba(0, 0, 0, 0.7);
        border: 2px solid #ffd700;
        border-radius: 15px;
        overflow: hidden;
        margin-bottom: 20px;
      }

      .table-header {
        background: linear-gradient(45deg, #ffd700, #ffed4e);
        color: #000;
        padding: 15px;
        font-weight: bold;
        font-size: 1.1rem;
      }

      .table-content {
        max-height: 600px;
        overflow-y: auto;
      }

      .player-row {
        display: grid;
        grid-template-columns: 1fr 2fr 1fr 2fr 2fr 1fr;
        gap: 15px;
        padding: 20px;
        border-bottom: 1px solid rgba(255, 215, 0, 0.3);
        align-items: center;
        transition: background 0.3s ease;
      }

      .player-row:hover {
        background: rgba(255, 215, 0, 0.1);
      }

      .player-row:last-child {
        border-bottom: none;
      }

      .player-info {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .player-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: white;
        font-size: 1.2rem;
      }

      .player-name {
        font-weight: bold;
        color: #ffd700;
        font-size: 1.1rem;
      }

      .question-info {
        text-align: center;
      }

      .question-number {
        color: #ffd700;
        font-weight: bold;
        margin-bottom: 5px;
      }

      .prize-amount {
        color: #4caf50;
        font-size: 0.9rem;
      }

      .answer-info {
        text-align: center;
      }

      .last-answer {
        font-weight: bold;
        margin-bottom: 5px;
      }

      .answer-correct {
        color: #4caf50;
      }

      .answer-incorrect {
        color: #f44336;
      }

      .answer-pending {
        color: #ff9800;
      }

      .lifelines-used {
        display: flex;
        gap: 10px;
        justify-content: center;
        flex-wrap: wrap;
      }

      .lifeline-badge {
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: bold;
        text-align: center;
      }

      .lifeline-used {
        background: #666;
        color: #ccc;
      }

      .lifeline-available {
        background: linear-gradient(45deg, #ffd700, #ffed4e);
        color: #000;
      }

      .status-indicator {
        text-align: center;
        font-weight: bold;
        padding: 8px 15px;
        border-radius: 20px;
      }

      .status-playing {
        background: #4caf50;
        color: white;
      }

      .status-eliminated {
        background: #f44336;
        color: white;
      }

      .status-winner {
        background: linear-gradient(45deg, #ffd700, #ffed4e);
        color: #000;
      }

      .refresh-btn {
        background: linear-gradient(45deg, #ffd700, #ffed4e);
        color: #000;
        border: none;
        border-radius: 25px;
        padding: 12px 30px;
        font-size: 1rem;
        font-weight: bold;
        cursor: pointer;
        margin-bottom: 20px;
        transition: transform 0.3s ease;
      }

      .refresh-btn:hover {
        transform: scale(1.05);
      }

      .game-controls {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        justify-content: center;
        flex-wrap: wrap;
      }

      .control-btn {
        background: linear-gradient(45deg, #ffd700, #ffed4e);
        color: #000;
        border: none;
        border-radius: 25px;
        padding: 12px 30px;
        font-size: 1rem;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        min-width: 150px;
      }

      .control-btn:hover {
        transform: scale(1.05);
      }

      .control-btn.start-game {
        background: linear-gradient(45deg, #4caf50, #45a049);
        color: white;
      }

      .control-btn.end-game {
        background: linear-gradient(45deg, #f44336, #d32f2f);
        color: white;
      }

      .control-btn.next-question {
        background: linear-gradient(45deg, #2196f3, #1976d2);
        color: white;
      }

      .control-btn.reveal-answer {
        background: linear-gradient(45deg, #ff9800, #f57c00);
        color: white;
      }

      .control-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      .control-btn:disabled:hover {
        transform: none;
      }

      .game-status {
        text-align: center;
        margin-bottom: 20px;
        padding: 15px;
        border-radius: 10px;
        font-weight: bold;
        font-size: 1.1rem;
      }

      .game-status.active {
        background: rgba(76, 175, 80, 0.2);
        border: 2px solid #4caf50;
        color: #4caf50;
      }

      .game-status.inactive {
        background: rgba(244, 67, 54, 0.2);
        border: 2px solid #f44336;
        color: #f44336;
      }

      .no-players {
        text-align: center;
        padding: 40px 20px;
        color: #888;
        font-style: italic;
      }

      .current-question-panel {
        background: rgba(0, 0, 0, 0.7);
        border: 2px solid #4caf50;
        border-radius: 15px;
        margin-bottom: 20px;
        overflow: hidden;
      }

      .current-question-content {
        padding: 20px;
      }

      .no-current-question {
        text-align: center;
        color: #888;
        font-style: italic;
        padding: 20px;
      }

      .question-display {
        background: rgba(76, 175, 80, 0.1);
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
      }

      .question-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid rgba(76, 175, 80, 0.3);
      }

      .question-title {
        font-size: 1.2rem;
        color: #4caf50;
        font-weight: bold;
      }

      .question-id {
        color: #888;
        font-size: 0.9rem;
      }

      .question-text {
        font-size: 1.1rem;
        line-height: 1.6;
        margin-bottom: 20px;
        color: #fff;
      }

      .question-options {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
        margin-bottom: 20px;
      }

      .option-item {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        padding: 10px 15px;
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .option-item.correct {
        background: rgba(76, 175, 80, 0.2);
        border-color: #4caf50;
        color: #4caf50;
        font-weight: bold;
      }

      .correct-answer-display {
        text-align: center;
        background: rgba(76, 175, 80, 0.2);
        border: 1px solid #4caf50;
        border-radius: 8px;
        padding: 15px;
        color: #4caf50;
        font-weight: bold;
        font-size: 1.1rem;
      }

      .notifications-panel {
        background: rgba(0, 0, 0, 0.7);
        border: 2px solid #ffd700;
        border-radius: 15px;
        margin-bottom: 20px;
        overflow: hidden;
      }

      .notifications-header {
        background: linear-gradient(45deg, #ffd700, #ffed4e);
        color: #000;
        padding: 15px;
        font-weight: bold;
        font-size: 1.1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .notifications-content {
        max-height: 300px;
        overflow-y: auto;
        padding: 0;
      }

      .notification-item {
        padding: 15px;
        border-bottom: 1px solid rgba(255, 215, 0, 0.3);
        display: flex;
        align-items: center;
        gap: 15px;
        transition: background 0.3s ease;
      }

      .notification-item:hover {
        background: rgba(255, 215, 0, 0.1);
      }

      .notification-item:last-child {
        border-bottom: none;
      }

      .notification-icon {
        font-size: 1.5rem;
        min-width: 30px;
        text-align: center;
      }

      .notification-content {
        flex: 1;
      }

      .notification-message {
        color: #ffd700;
        font-weight: bold;
        margin-bottom: 5px;
      }

      .notification-details {
        color: #ccc;
        font-size: 0.9rem;
      }

      .notification-time {
        color: #888;
        font-size: 0.8rem;
        min-width: 60px;
        text-align: right;
      }

      .clear-notifications-btn {
        background: transparent;
        border: 1px solid rgba(255, 215, 0, 0.5);
        color: #ffd700;
        padding: 5px 10px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 0.8rem;
        transition: all 0.3s ease;
      }

      .clear-notifications-btn:hover {
        background: rgba(255, 215, 0, 0.1);
        border-color: #ffd700;
      }

      .no-notifications {
        padding: 20px;
        text-align: center;
        color: #888;
        font-style: italic;
      }

      @media (max-width: 768px) {
        .admin-title {
          font-size: 2rem;
        }

        .player-row {
          grid-template-columns: 1fr;
          gap: 10px;
          text-align: center;
        }

        .stats-overview {
          grid-template-columns: repeat(2, 1fr);
        }
      }
    </style>
  </head>
  <body>
    <div class="admin-container">
      <div class="admin-header">
        <h1 class="admin-title">Panel de Administración</h1>
        <p class="admin-subtitle">Monitoreo de participantes en tiempo real</p>
      </div>

      <div class="stats-overview">
        <div class="stat-card">
          <div class="stat-number" id="totalPlayers">0</div>
          <div class="stat-label">Total Participantes</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="activePlayers">0</div>
          <div class="stat-label">Jugando Actualmente</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="eliminatedPlayers">0</div>
          <div class="stat-label">Eliminados</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="playersAnswered">0</div>
          <div class="stat-label">Han Respondido</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="playersPending">0</div>
          <div class="stat-label">Pendientes</div>
        </div>
      </div>

      <div class="game-status" id="gameStatus">
        🔴 Partida Detenida - Los jugadores no pueden ingresar
      </div>

      <div class="game-controls">
        <button
          class="control-btn start-game"
          id="startGameBtn"
          onclick="startGame()"
        >
          🎮 Iniciar Partida
        </button>
        <button
          class="control-btn end-game"
          id="endGameBtn"
          onclick="endGame()"
          disabled
        >
          🛑 Terminar Partida
        </button>
        <button
          class="control-btn next-question"
          id="nextQuestionBtn"
          onclick="nextQuestion()"
          disabled
        >
          ➡️ Siguiente Pregunta
        </button>
        <button
          class="control-btn reveal-answer"
          id="revealAnswerBtn"
          onclick="revealAnswer()"
          disabled
        >
          💡 Revelar Respuesta
        </button>
        <button class="refresh-btn" onclick="refreshData()">
          🔄 Actualizar Datos
        </button>
      </div>

      <div class="current-question-panel">
        <div class="table-header">📋 Pregunta Actual</div>
        <div class="current-question-content" id="currentQuestionContent">
          <div class="no-current-question">No hay pregunta activa</div>
        </div>
      </div>

      <div class="notifications-panel">
        <div class="notifications-header">
          <span>🔔 Actividad en Tiempo Real</span>
          <button
            class="clear-notifications-btn"
            onclick="clearNotifications()"
          >
            Limpiar
          </button>
        </div>
        <div class="notifications-content" id="notificationsContent">
          <div class="no-notifications">No hay actividad reciente</div>
        </div>
      </div>

      <div class="players-table">
        <div class="table-header">Participantes Registrados</div>
        <div class="table-content" id="playersTableContent">
          <!-- Los datos se cargarán aquí -->
        </div>
      </div>
    </div>

    <script>
      // Estado del juego
      let gameState = {
        isActive: false,
        startTime: null,
        endTime: null,
      };

      // Notificaciones en tiempo real
      let notifications = [];

      // WebSocket para comunicación en tiempo real
      let ws = null;

      function connectWebSocket() {
        const protocol = window.location.protocol === "https:" ? "wss:" : "ws:";
        const wsUrl = `${protocol}//${window.location.host}/ws`;

        ws = new WebSocket(wsUrl);

        ws.onopen = function () {
          console.log("✅ WebSocket conectado al servidor");
        };

        ws.onmessage = function (event) {
          try {
            const message = JSON.parse(event.data);
            handleWebSocketMessage(message);
          } catch (error) {
            console.error("❌ Error procesando mensaje WebSocket:", error);
          }
        };

        ws.onclose = function () {
          console.log(
            "🔌 WebSocket desconectado. Reintentando en 3 segundos..."
          );
          setTimeout(connectWebSocket, 3000);
        };

        ws.onerror = function (error) {
          console.error("❌ Error WebSocket:", error);
        };
      }

      function handleWebSocketMessage(message) {
        switch (message.type) {
          case "gameState":
            updateGameStateFromWebSocket(message.data);
            break;
          case "lifelineUsed":
            addNotification(
              "🎯",
              message.data.message,
              `Pregunta ${message.data.currentQuestion} - ${message.data.lifelineType}`,
              message.data.timestamp
            );
            break;
          case "answerSubmitted":
            addNotification(
              message.data.icon,
              message.data.message,
              `Pregunta ${message.data.questionNumber} - Opción ${message.data.selectedOption} (Correcta: ${message.data.correctOption})`,
              message.data.timestamp
            );
            break;
          case "playerJoined":
            addNotification(
              "👤",
              message.data.message,
              "Nuevo participante en el juego",
              message.data.timestamp
            );
            break;
          default:
            console.log("📨 Mensaje WebSocket no reconocido:", message);
        }
      }

      function updateGameStateFromWebSocket(newGameState) {
        gameState.isActive = newGameState.isActive;
        gameState.startTime = newGameState.startTime
          ? new Date(newGameState.startTime)
          : null;
        gameState.endTime = newGameState.endTime
          ? new Date(newGameState.endTime)
          : null;

        updateGameStatus();
        updateControlButtons();

        // Mostrar notificación
        const status = newGameState.isActive ? "iniciada" : "terminada";
        console.log(`🎮 Partida ${status} remotamente`);

        // Refrescar datos de jugadores cuando cambie el estado
        setTimeout(refreshData, 1000);
      }

      // Datos de participantes (se cargarán desde la API)
      let playersData = [];

      async function loadSessionsData() {
        try {
          const response = await fetch("/api/sessions/active");
          const data = await response.json();

          if (data.success && data.data.sessions) {
            playersData = data.data.sessions.map((session, index) => {
              const avatars = [
                "🎯",
                "⭐",
                "🔥",
                "💎",
                "🌟",
                "🎪",
                "🚀",
                "👤",
                "🎨",
                "🎵",
              ];
              return {
                id: session.id,
                name: session.playerName,
                avatar: avatars[index % avatars.length],
                currentQuestion: session.currentQuestion,
                prizeAmount: `$${session.totalPrize.toLocaleString()}`,
                lastAnswer:
                  session.answersGiven.length > 0
                    ? session.answersGiven[session.answersGiven.length - 1]
                        .selectedOption
                    : "-",
                answerStatus:
                  session.answersGiven.length > 0
                    ? session.answersGiven[session.answersGiven.length - 1]
                        .isCorrect
                      ? "correct"
                      : "incorrect"
                    : "pending",
                lifelinesUsed: {
                  fiftyFifty: session.lifelinesUsed.fiftyFifty,
                  audience: session.lifelinesUsed.audience,
                },
                status:
                  session.gameStatus === "active"
                    ? "playing"
                    : session.gameStatus === "eliminated"
                    ? "eliminated"
                    : session.gameStatus === "finished"
                    ? session.totalPrize > 0
                      ? "winner"
                      : "eliminated"
                    : "eliminated",
                joinTime: new Date(session.startTime).toLocaleTimeString(),
                sessionObject: session,
              };
            });

            console.log(`✅ ${playersData.length} sesiones activas cargadas`);
          } else {
            playersData = [];
            console.log("ℹ️ No hay sesiones activas");
          }
        } catch (error) {
          console.error("❌ Error cargando sesiones:", error);
          playersData = [];
        }
      }

      // Estado de respuestas de los jugadores
      let playersStatus = {
        totalPlayers: 0,
        playersAnswered: 0,
        playersPending: 0,
        currentQuestion: 0,
        players: [],
      };

      function updateStats() {
        const total = playersData.length;
        const active = playersData.filter((p) => p.status === "playing").length;
        const eliminated = playersData.filter(
          (p) => p.status === "eliminated"
        ).length;

        document.getElementById("totalPlayers").textContent = total;
        document.getElementById("activePlayers").textContent = active;
        document.getElementById("eliminatedPlayers").textContent = eliminated;

        // Actualizar estadísticas de respuestas
        document.getElementById("playersAnswered").textContent =
          playersStatus.playersAnswered;
        document.getElementById("playersPending").textContent =
          playersStatus.playersPending;
      }

      async function loadPlayersStatus() {
        try {
          const response = await fetch("/api/sessions/status");
          const data = await response.json();

          if (data.success) {
            playersStatus = data.data;
            console.log("✅ Estado de jugadores cargado:", playersStatus);
          } else {
            console.error("❌ Error cargando estado de jugadores:", data.error);
          }
        } catch (error) {
          console.error(
            "❌ Error de conexión para estado de jugadores:",
            error
          );
        }
      }

      function getAnswerStatusText(status) {
        switch (status) {
          case "correct":
            return "Correcta";
          case "incorrect":
            return "Incorrecta";
          case "pending":
            return "Pendiente";
          default:
            return "-";
        }
      }

      function getStatusClass(status) {
        switch (status) {
          case "correct":
            return "answer-correct";
          case "incorrect":
            return "answer-incorrect";
          case "pending":
            return "answer-pending";
          default:
            return "";
        }
      }

      function renderLifelines(lifelines) {
        const lifelineNames = {
          fiftyFifty: "50:50",
          audience: "Público",
        };

        return Object.entries(lifelines)
          .map(([key, used]) => {
            const className = used ? "lifeline-used" : "lifeline-available";
            const text = used
              ? `${lifelineNames[key]} ✗`
              : `${lifelineNames[key]} ✓`;
            return `<span class="lifeline-badge ${className}">${text}</span>`;
          })
          .join("");
      }

      function getStatusIndicator(status) {
        const statusTexts = {
          playing: "Jugando",
          eliminated: "Eliminado",
          winner: "Ganador",
        };
        return `<div class="status-indicator status-${status}">${statusTexts[status]}</div>`;
      }

      function renderPlayersTable() {
        const tableContent = document.getElementById("playersTableContent");

        if (playersData.length === 0) {
          tableContent.innerHTML =
            '<div class="no-players">No hay participantes registrados</div>';
          return;
        }

        const playersHTML = playersData
          .map(
            (player) => `
                <div class="player-row">
                    <div class="player-info">
                        <div class="player-avatar">${player.avatar}</div>
                        <div>
                            <div class="player-name">${player.name}</div>
                            <div style="color: #999; font-size: 0.8rem;">Ingresó: ${
                              player.joinTime
                            }</div>
                        </div>
                    </div>
                    <div class="question-info">
                        <div class="question-number">Pregunta ${
                          player.currentQuestion
                        }/15</div>
                        <div class="prize-amount">${player.prizeAmount}</div>
                    </div>
                    <div class="answer-info">
                        <div class="last-answer ${getStatusClass(
                          player.answerStatus
                        )}">
                            ${player.lastAnswer}
                        </div>
                        <div style="font-size: 0.8rem; color: #ccc;">
                            ${getAnswerStatusText(player.answerStatus)}
                        </div>
                    </div>
                    <div class="lifelines-used">
                        ${renderLifelines(player.lifelinesUsed)}
                    </div>
                    <div>
                        ${getStatusIndicator(player.status)}
                    </div>
                    <div style="text-align: center; color: #ccc; font-size: 0.9rem;">
                        ID: ${player.id.substring(0, 8)}...
                    </div>
                </div>
            `
          )
          .join("");

        tableContent.innerHTML = playersHTML;
      }

      async function loadCurrentQuestion() {
        try {
          const response = await fetch("/api/admin/current-question");
          const data = await response.json();

          if (data.success) {
            renderCurrentQuestion(data.data);
          } else {
            console.error("❌ Error cargando pregunta actual:", data.error);
            renderCurrentQuestion({
              hasActivePlayers: false,
              message: "Error cargando pregunta",
            });
          }
        } catch (error) {
          console.error("❌ Error de red cargando pregunta actual:", error);
          renderCurrentQuestion({
            hasActivePlayers: false,
            message: "Error de conexión",
          });
        }
      }

      function renderCurrentQuestion(questionData) {
        const contentDiv = document.getElementById("currentQuestionContent");

        if (!questionData.hasActivePlayers) {
          contentDiv.innerHTML = `
            <div class="no-current-question">
              ${questionData.message || "No hay jugadores activos"}
            </div>
          `;
          return;
        }

        const question = questionData.currentQuestion;
        const stats = questionData.questionStats;

        if (!question) {
          contentDiv.innerHTML = `
            <div class="no-current-question">
              No se pudo cargar la pregunta actual
            </div>
          `;
          return;
        }

        contentDiv.innerHTML = `
          <div class="question-display">
            <div class="question-header">
              <div class="question-title">Pregunta ${stats.questionNumber}</div>
              <div class="question-id">ID: ${question.id}</div>
            </div>
            
            <div class="question-text">${question.question}</div>
            
            <div class="question-options">
              <div class="option-item ${
                question.correctAnswer === "A" ? "correct" : ""
              }">
                A) ${question.options?.A || "N/A"}
              </div>
              <div class="option-item ${
                question.correctAnswer === "B" ? "correct" : ""
              }">
                B) ${question.options?.B || "N/A"}
              </div>
              <div class="option-item ${
                question.correctAnswer === "C" ? "correct" : ""
              }">
                C) ${question.options?.C || "N/A"}
              </div>
              <div class="option-item ${
                question.correctAnswer === "D" ? "correct" : ""
              }">
                D) ${question.options?.D || "N/A"}
              </div>
            </div>
            
            <div class="correct-answer-display">
              ✅ Respuesta Correcta: ${question.correctAnswer}) ${
          question.options?.[question.correctAnswer] || "N/A"
        }
            </div>
            
            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(76, 175, 80, 0.3); font-size: 0.9rem; color: #ccc;">
              <strong>📊 Estadísticas:</strong><br>
              • ${stats.playersOnThis} de ${
          stats.totalActive
        } jugadores activos en esta pregunta<br>
              • ${
                stats.totalEliminated
              } jugadores eliminados (modo espectador)<br>
              • Dificultad: ${question.difficulty}/5 | Premio: ${getPrizeAmount(
          stats.questionNumber
        )}
            </div>
          </div>
        `;
      }

      async function refreshData() {
        // Cargar datos reales desde la API
        const refreshBtn = document.querySelector(".refresh-btn");
        refreshBtn.textContent = "🔄 Actualizando...";
        refreshBtn.disabled = true;

        try {
          await loadSessionsData();
          await loadCurrentQuestion(); // Cargar pregunta actual
          await loadPlayersStatus(); // Cargar estado de respuestas
          updateStats();
          renderPlayersTable();

          console.log("✅ Datos actualizados desde la API");
        } catch (error) {
          console.error("❌ Error actualizando datos:", error);
        } finally {
          refreshBtn.textContent = "🔄 Actualizar Datos";
          refreshBtn.disabled = false;
        }
      }

      function getPrizeAmount(questionNumber) {
        const prizes = [
          "$100",
          "$200",
          "$300",
          "$500",
          "$1,000",
          "$2,000",
          "$4,000",
          "$8,000",
          "$16,000",
          "$32,000",
          "$64,000",
          "$125,000",
          "$250,000",
          "$500,000",
          "$1,000,000",
        ];
        return prizes[questionNumber - 1] || "$0";
      }

      // Inicializar la página
      document.addEventListener("DOMContentLoaded", async function () {
        // Conectar WebSocket
        connectWebSocket();

        // Cargar estado inicial del juego
        await loadGameState();

        updateGameStatus();
        updateControlButtons();

        // Cargar datos iniciales
        await loadSessionsData();
        await loadCurrentQuestion(); // Cargar pregunta actual
        await loadPlayersStatus(); // Cargar estado de respuestas
        updateStats();
        renderPlayersTable();

        // Auto-actualizar cada 30 segundos
        setInterval(() => {
          if (!document.querySelector(".refresh-btn").disabled) {
            refreshData();
          }
        }, 30000);
      });

      async function loadGameState() {
        try {
          const response = await fetch("/api/game/state");
          const data = await response.json();

          if (data.success && data.data.gameState) {
            const gs = data.data.gameState;
            gameState.isActive = gs.isActive;
            gameState.startTime = gs.startTime ? new Date(gs.startTime) : null;
            gameState.endTime = gs.endTime ? new Date(gs.endTime) : null;
            console.log("✅ Estado del juego cargado:", gs.message);
          }
        } catch (error) {
          console.error("❌ Error cargando estado del juego:", error);
        }
      }

      // Agregar nuevo participante (función de ejemplo)
      function addNewPlayer(name) {
        const avatars = [
          "🎯",
          "⭐",
          "🔥",
          "💎",
          "🌟",
          "🎪",
          "🚀",
          "👤",
          "🎨",
          "🎵",
        ];
        const newPlayer = {
          id: playersData.length + 1,
          name: name,
          avatar: avatars[Math.floor(Math.random() * avatars.length)],
          currentQuestion: 1,
          prizeAmount: "$100",
          lastAnswer: "-",
          answerStatus: "pending",
          lifelinesUsed: {
            fiftyFifty: false,
            audience: false,
          },
          status: "playing",
          joinTime: new Date().toLocaleTimeString(),
        };

        playersData.push(newPlayer);
        updateStats();
        renderPlayersTable();
      }

      async function startGame() {
        try {
          const response = await fetch("/api/game/start", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
          });

          const data = await response.json();

          if (data.success) {
            console.log("✅ Partida iniciada:", data.message);
            // El WebSocket se encargará de actualizar la UI
          } else {
            alert("❌ Error iniciando partida: " + data.error);
          }
        } catch (error) {
          console.error("❌ Error iniciando partida:", error);
          alert("Error de conexión al iniciar partida");
        }
      }

      async function endGame() {
        const confirmEnd = confirm(
          "¿Estás seguro de que quieres terminar la partida? Esto eliminará a todos los jugadores activos."
        );

        if (!confirmEnd) return;

        try {
          const response = await fetch("/api/game/end", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
          });

          const data = await response.json();

          if (data.success) {
            console.log("✅ Partida terminada:", data.message);
            // El WebSocket se encargará de actualizar la UI
          } else {
            alert("❌ Error terminando partida: " + data.error);
          }
        } catch (error) {
          console.error("❌ Error terminando partida:", error);
          alert("Error de conexión al terminar partida");
        }
      }

      async function nextQuestion() {
        // Verificar si todos los jugadores han respondido
        await loadPlayersStatus();

        if (playersStatus.playersPending > 0) {
          const confirmNext = confirm(
            `⚠️ Aún hay ${playersStatus.playersPending} jugadores que no han respondido la pregunta actual.\n\n¿Estás seguro de que quieres avanzar a la siguiente pregunta?`
          );

          if (!confirmNext) return;
        } else {
          const confirmNext = confirm(
            "✅ Todos los jugadores han respondido.\n\n¿Quieres avanzar a la siguiente pregunta?"
          );

          if (!confirmNext) return;
        }

        try {
          const response = await fetch("/api/game/next-question", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
          });

          const data = await response.json();

          if (data.success) {
            console.log("✅ Avanzado a la siguiente pregunta:", data.message);
            // Actualizar inmediatamente la pregunta actual en el admin
            setTimeout(async () => {
              await loadCurrentQuestion();
              await loadPlayersStatus();
              updateStats();
            }, 1000);
          } else {
            alert("❌ Error avanzando pregunta: " + data.error);
          }
        } catch (error) {
          console.error("❌ Error avanzando pregunta:", error);
          alert("Error de conexión al avanzar pregunta");
        }
      }

      async function revealAnswer() {
        const confirmReveal = confirm(
          "¿Estás seguro de que quieres revelar la respuesta correcta? Esto se mostrará a todos los jugadores."
        );

        if (!confirmReveal) return;

        try {
          const response = await fetch("/api/game/reveal-answer", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
          });

          const data = await response.json();

          if (data.success) {
            console.log("✅ Respuesta revelada:", data.message);
            // El WebSocket se encargará de actualizar la UI
          } else {
            alert("❌ Error revelando respuesta: " + data.error);
          }
        } catch (error) {
          console.error("❌ Error revelando respuesta:", error);
          alert("Error de conexión al revelar respuesta");
        }
      }

      function updateGameStatus() {
        const statusElement = document.getElementById("gameStatus");

        if (gameState.isActive) {
          statusElement.className = "game-status active";
          statusElement.innerHTML = `
                    🟢 Partida Activa - Los jugadores pueden ingresar
                    <br><small>Iniciada: ${gameState.startTime.toLocaleTimeString()}</small>
                `;
        } else {
          statusElement.className = "game-status inactive";
          const endTimeText = gameState.endTime
            ? `<br><small>Terminada: ${gameState.endTime.toLocaleTimeString()}</small>`
            : "";
          statusElement.innerHTML = `
                    🔴 Partida Detenida - Los jugadores no pueden ingresar
                    ${endTimeText}
                `;
        }
      }

      function updateControlButtons() {
        const startBtn = document.getElementById("startGameBtn");
        const endBtn = document.getElementById("endGameBtn");
        const nextQuestionBtn = document.getElementById("nextQuestionBtn");
        const revealAnswerBtn = document.getElementById("revealAnswerBtn");

        if (gameState.isActive) {
          startBtn.disabled = true;
          startBtn.textContent = "🎮 Partida en Curso";
          endBtn.disabled = false;
          endBtn.textContent = "🛑 Terminar Partida";
          nextQuestionBtn.disabled = false;
          revealAnswerBtn.disabled = false;
        } else {
          startBtn.disabled = false;
          startBtn.textContent = "🎮 Iniciar Partida";
          endBtn.disabled = true;
          endBtn.textContent = "🛑 Partida Detenida";
          nextQuestionBtn.disabled = true;
          revealAnswerBtn.disabled = true;
        }
      }

      // Funciones para manejar notificaciones
      function addNotification(icon, message, details, timestamp) {
        const notification = {
          id: Date.now(),
          icon: icon,
          message: message,
          details: details,
          timestamp: timestamp,
          time: new Date(timestamp),
        };

        notifications.unshift(notification); // Agregar al inicio

        // Limitar a 50 notificaciones máximo
        if (notifications.length > 50) {
          notifications = notifications.slice(0, 50);
        }

        renderNotifications();

        // Log para debugging
        console.log(`📢 ${icon} ${message} - ${details}`);
      }

      function renderNotifications() {
        const container = document.getElementById("notificationsContent");

        if (notifications.length === 0) {
          container.innerHTML =
            '<div class="no-notifications">No hay actividad reciente</div>';
          return;
        }

        const notificationsHTML = notifications
          .map((notification) => {
            const timeString = notification.time.toLocaleTimeString();
            return `
            <div class="notification-item">
              <div class="notification-icon">${notification.icon}</div>
              <div class="notification-content">
                <div class="notification-message">${notification.message}</div>
                <div class="notification-details">${notification.details}</div>
              </div>
              <div class="notification-time">${timeString}</div>
            </div>
          `;
          })
          .join("");

        container.innerHTML = notificationsHTML;
      }

      function clearNotifications() {
        notifications = [];
        renderNotifications();
        console.log("🧹 Notificaciones limpiadas");
      }
    </script>
  </body>
</html>
